pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- init e update

function _init()
  t=0
  _upd=update_game
  _drw=draw_game
  start_game()
end

function _update()
  t+=1
  _upd()
end

function _draw()
  _drw()
end

-->8
-- menu principal

function update_menu()
  if btnp(5) then -- x
    start_transition(1)
  end
end

function draw_menu()
  cls(0)
  print("ultimo turno", 34, 40, 7)
  print("pressione ❎ para comecar", 20, 60, 6)
end

-->8
-- tela de dica / preparacao

function update_hint()
  if btnp(5) then -- x
    start_transition(2)
    start_level1()
  end
end

function draw_hint()
  cls(0)
  print("dica:", 4, 20, 8)
  print("empurre as lapides para o lugar certo", 4, 40, 7)
  print("antes do nascer do sol...", 20, 50, 7)
  print("pressione ❎ para voltar", 28, 80, 6)
end

-->8
-- player

p = {
  spr = {16,17},
  x = 0,
  y = 0,
  ox = 0,
  oy = 0,
  tile_size = 8,
  move_delay = 0.2, -- quanto maior, mais lento
  move_timer = 0
}

function update_player()
  -- contador de delay para repeticao
  if p.move_timer > 0 then
    p.move_timer -= 0.1
    return
  end

  local dx, dy = 0, 0

  -- esquerda
  if btnp(0) then
    dx = -1
    p.ox = 8
    _upd = update_pturn
  end
  -- direita
  if btnp(1) then
    dx = 1
    p.ox = -8
    _upd = update_pturn
  end
   -- cima
  if btnp(2) then
    dy = -1
    p.oy = 8
    _upd = update_pturn
  end
  -- baixo
  if btnp(3) then
    dy = 1
    p.oy = -8
    _upd = update_pturn
  end

  -- se nenhum direcional foi apertado, sai
  if dx == 0 and dy == 0 then
    return
  end

  -- calcula posicao destino em pixels
  local nx = p.x + dx * p.tile_size
  local ny = p.y + dy * p.tile_size

  -- checa colisao usando caixa
  if not solid_at(nx, ny) then
    p.x = nx
    p.y = ny
  end

  -- aplica delay para evitar movimento continuo muito rapido
  p.move_timer = p.move_delay
end

function update_pturn()
  if p.ox>0 then
    p.ox-=1
  end
  if p.ox<0 then
    p.ox+=1
  end
  if p.oy>0 then
    p.oy-=1
  end
  if p.oy<0 then
    p.oy+=1
  end
  if p.ox==0 and p.oy==0 then
    _upd=update_game
  end
end

function draw_player()
  spr(get_frame(p.spr), p.x + p.ox, p.y + p.oy)
end

-- checa se alguma parte da caixa do jogador encosta em tiles solidos
function solid_at(x, y)
  local w = 7 -- largura aproximada do sprite do jogador
  local h = 7 -- altura aproximada

  -- checa os quatro cantos da bounding box
  return tile_solid(x, y)
    or tile_solid(x + w, y)
    or tile_solid(x, y + h)
    or tile_solid(x + w, y + h)
end

-- checa se um pixel esta dentro de um tile solido
function tile_solid(px, py)
  local tile_x = flr(px / 8)
  local tile_y = flr(py / 8)
  local tile = mget(tile_x, tile_y)
  return fget(tile, 0)
end

-->8
-- game

function start_game()
  p.x = 8 * p.tile_size
  p.y = 13 * p.tile_size
end

function update_game()
  update_player()
end

function draw_game()
  cls()
  map(0, 0, 0, 0, 16, 16)
  draw_player()
end

-->8
-- auxiliares

function get_frame(ani)
  return ani[flr(t/8)%#ani+1]
end
__gfx__
0000000033333333dddddddd00555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000033333333d555555d05666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070033333333d555555d56666660006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700033333333d555555d56dddd60006666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333336666666656666660000660600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333331111111156666660000066600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333331111111156666360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000003333333f1111111156363360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222220000000000222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02211112002222202111122000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22171712022111122171712200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22171712221717122171712200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02111112221717122111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222220021111120222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02221220002222200221222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02211220022212200221122000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01667711016677110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16677771166777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16707071167070710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16707071167070710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16777771167777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16716161161616610000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01101010010101100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010202020201010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
