pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- init e update
function _init()
  t = 0
  p_ani = {16,17}
  
  dirx={-1,1,0,0}
  diry={0,0,-1,1}
  
  tombs = {}
  
  game_init()
end
 
function _update()
  t += 1
  _upd()
end
 
function _draw()
 _drw()
end
 
function start_game()
 p_t = 0
 p_x = 8
 p_y = 13
 p_ox = 0
 p_oy = 0
 p_sox = 0
 p_soy = 0
 p_flip = false
 
 p_mov = nil
end
-->8
-- game

function game_init()
  start_game()
  add_tomb(6, 12, 18)
  add_tomb(8, 12, 18)
  set_state(update_game, draw_game)
end

function update_game()
  for i=0,3 do
    if btnp(i) then
      move_player(dirx[i+1], diry[i+1])
      return
    end
  end
end

function update_pturn()
  p_t = min(p_t+0.125, 1)
 
  p_mov()
  
  tomb_mov()

  if p_t == 1 then
   _upd = update_game
  end
end

function mov_walk()
  p_ox = p_sox * (1-p_t)
  p_oy = p_soy * (1-p_t)
end

function mov_bump()
  local mov_time = p_t
  if p_t > 0.5 then
    mov_time = 1 - p_t
  end
  p_ox = p_sox * mov_time
  p_oy = p_soy * mov_time
end

function tomb_mov()
  for tomb in all(tombs) do
	  if tomb.t < 1 then
	    tomb.t = min(tomb.t + 0.125, 1)
	    tomb.ox *= (1 - tomb.t)
	    tomb.oy *= (1 - tomb.t)
	  end
	 end
end
 
function draw_game()
  cls(0)
  map()
  -- lapides
  for tomb in all(tombs) do
    spr(tomb.s, tomb.x * 8 + tomb.ox, tomb.y * 8 + tomb.oy)
  end
  -- jogador
  draw_spr(get_frame(p_ani), p_x * 8 + p_ox, p_y * 8 + p_oy, p_flip)
end
-->8
-- auxiliares

function get_frame(ani)
  return ani[flr(t/8) % #ani+1]
end

function draw_spr(_spr,_x,_y, _flip)
  spr(_spr, _x, _y, 1, 1, _flip)
end

function set_state(upd, drw)
  _upd = upd
  _drw = drw
end

function add_tomb(x, y, _spr)
  add(tombs, {
    x = x,
    y = y,
    ox = 0,
    oy = 0,
    t = 1,
    s = _spr
  })
end

function tomb_at(x, y)
  for t in all(tombs) do
    if t.x == x and t.y == y then
      return t
    end
  end
  return nil
end

-->8
-- gameplay

function move_player(dx, dy)
  local dest_x, dest_y = p_x+dx, p_y+dy
	 local tile = mget(dest_x, dest_y)
	 
  if dx < 0 then
    p_flip = true
  elseif dx > 0 then
    p_flip = false
  end
  
  -- colisao com parede
	 if fget(tile, 0) then
	   start_bump(dx, dy)
		  return
		end
		
		-- colisao com lapide
		local tomb = tomb_at(dest_x, dest_y)

  if tomb then
		  local push_x, push_y = dest_x+dx, dest_y+dy
		  
		  -- se ha parede ou outra
		  -- lapide, bump
		  if fget(mget(push_x, push_y),0) or tomb_at(push_x, push_y) then
		    start_bump(dx, dy)
		    return
		  end
		  
		  -- inicia animacao da lapide
		  tomb.x += dx
		  tomb.y += dy
		  tomb.ox = -dx*8
		  tomb.oy = -dy*8
		  tomb.t = 0
		end
	 
  p_x += dx
  p_y += dy
 
  start_walk(dx, dy)
end

function start_bump(dx, dy)
  p_sox,p_soy = dx*4,dy*4
  p_ox,p_oy = 0,0
  p_t = 0
  _upd  = update_pturn
  p_mov = mov_bump
end

function start_walk(dx, dy)
  p_sox,p_soy = -dx*8,-dy*8
  p_ox,p_oy = p_sox,p_soy
  p_t = 0
  _upd  = update_pturn
  p_mov = mov_walk
end

-->8
-- menu

function menu_init()
  set_state(menu_update, menu_draw)
end

function menu_update()
  if btnp(4) or btnp(5) then
    dica_init()
  end
end

function menu_draw()
  cls(0)
  print("ultimo turno", 32, 48, 7)
  print("pressione x ou o", 28, 80, 6)
end

-->8
-- pre jogo

function dica_init()
  set_state(dica_update, dica_draw)
  dica_t = 0
end

function dica_update()
  dica_t += 1
  if btnp(4) or btnp(5) or dica_t > 120 then
    game_init()
  end
end

function dica_draw()
  cls(1)
  print("antes do amanhecer,", 20, 48, 7)
  print("reorganize os tumulos.", 16, 60, 7)
  print("pressione para continuar", 10, 90, 6)
end

__gfx__
000000001111111155555555111111111111111111111111111111110dddddddddddddddddddddd0111111111111111111111111111111111111111111000011
000000001111111155555555111111d11111111111666111111111110d66666666666666666666d0111111111111111111111111111111111100001110666601
00700700111111115555555511111dd11d11111116111611116661110d77777777777777777777d011111111111111111111111111111111103bb30106777760
0007700011111111555555551d11dd111dd111111611161116111611056d666666d666666666d6501111111111111111111111111111111103bb7b3006070060
0007700011111111555555551dd1dd1111dd11d1116661111166611105dddddddddddddddddddd501111111111111111111111111111111103bbbb3006070060
00700700111d11115555555511d1d11111dd1d111111d1d11111d1d1056666d6666666d6666d665011111111111111111111111111111111033bb33006767660
00000000111111115555555511111111111d111111111dd111111dd1055555555555555555555550000000001111111111111111111111110033330010707701
000000001111111155555555111111111111111111111d1111111d110000000000000000000000000dddddd01111111111111111111111111003300111000011
002222200000000000555500115555111111111111111111111111111111111111111111111111110d6dd6d01111111111111111111111111044490100111111
022111120022222005666650156666511111111111111111111111111111111111111111111111110d6d66d01111111111111111111111111104101107001111
221717120221111256666660566666611111111111111111111111111111111111111111111111110d6d6dd01111111111111111111111111111111166770000
221717122217171256dddd6056dddd611111111111111111111111111111111111111111111111110d6d66d01111111111111111111111111111111100066760
021111122217171256666660566666611111111111111111111111111111111111111111111111110d6d66d01111111111111111111111111111111111110701
002222200211111256666660566666611111111111111111111111111111111111111111111111110d6d66d01111111111111111111111111111111111111011
022212200022222056666660566663611111111111111111111111111111111111111111111111110dddddd01111111111111111111111111111111111111111
022112200222122056666660563633611111111111111111111111111111111111111111111111110d66d6d01111111111111111111111111111111111111111
001111000011110000000000000000000000000000000000000000000000000000000000000000000d66d66dd666d6d000000000000000000000000000000000
016677110166771100000000000000000000000000000000000000000000000000000000000000000d666666666666d000000000000000000000000000000000
166777711667777100000000000000000000000000000000000000000000000000000000000000000d777777777777d000000000000000000000000000000000
16707071167070710000000000000000000000000000000000000000000000000000000000000000056d666666d6665000000000000000000000000000000000
1670707116707071000000000000000000000000000000000000000000000000000000000000000005dddddddddddd5000000000000000000000000000000000
16777671167777710000000000000000000000000000000000000000000000000000000000000000056666d666666d5000000000000000000000000000000000
16716161161616610000000000000000000000000000000000000000000000000000000000000000055555555555555000000000000000000000000000000000
01101010010101100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000010000000201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010202020202010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010102010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010102010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010102010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010102010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
