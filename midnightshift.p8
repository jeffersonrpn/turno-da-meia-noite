pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- init e update

function _init()
  _upd=update_game
  _drw=draw_game
  start_game()
end

function _update()
  _upd()
end

function _draw()
  _drw()
end

-->8
-- menu principal

function update_menu()
  if btnp(5) then -- x
    start_transition(1)
  end
end

function draw_menu()
  cls(0)
  print("ultimo turno", 34, 40, 7)
  print("pressione ❎ para comecar", 20, 60, 6)
end

-->8
-- tela de dica / preparacao

function update_hint()
  if btnp(5) then -- x
    start_transition(2)
    start_level1()
  end
end

function draw_hint()
  cls(0)
  print("dica:", 4, 20, 8)
  print("empurre as lapides para o lugar certo", 4, 40, 7)
  print("antes do nascer do sol...", 20, 50, 7)
  print("pressione ❎ para voltar", 28, 80, 6)
end

-->8
-- player

p = {
  x = 0,
  y = 0,
  spr = 16,
  tile_size = 8,
  move_delay = 1, -- quanto maior, mais lento
  move_timer = 0
}

function update_player()
  -- contador de delay para repeticao
  if p.move_timer > 0 then
    p.move_timer -= 1
    return
  end

  local dx, dy = 0, 0

  if btnp(0) then dx = -1 end -- esquerda
  if btnp(1) then dx = 1 end  -- direita
  if btnp(2) then dy = -1 end -- cima
  if btnp(3) then dy = 1 end  -- baixo

  -- se nenhum direcional foi apertado, sai
  if dx == 0 and dy == 0 then
    return
  end

  -- calcula posicao destino em pixels
  local nx = p.x + dx * p.tile_size
  local ny = p.y + dy * p.tile_size

  -- checa colisao usando caixa
  if not solid_at(nx, ny) then
    p.x = nx
    p.y = ny
  end

  -- aplica delay para evitar movimento continuo muito rapido
  p.move_timer = p.move_delay
end

function draw_player()
  spr(p.spr, p.x, p.y)
end

-- checa se alguma parte da caixa do jogador encosta em tiles solidos
function solid_at(x, y)
  local w = 7 -- largura aproximada do sprite do jogador
  local h = 7 -- altura aproximada

  -- checa os quatro cantos da bounding box
  return tile_solid(x, y)
    or tile_solid(x + w, y)
    or tile_solid(x, y + h)
    or tile_solid(x + w, y + h)
end

-- checa se um pixel esta dentro de um tile solido
function tile_solid(px, py)
  local tile_x = flr(px / 8)
  local tile_y = flr(py / 8)
  local tile = mget(tile_x, tile_y)
  return fget(tile, 0)
end

-->8
-- game

function start_game()
  p.x = 8 * p.tile_size
  p.y = 13 * p.tile_size
end

function update_game()
  update_player()
end

function draw_game()
  cls()
  map(0, 0, 0, 0, 16, 16)
  draw_player()
end

__gfx__
0000000033333333dddddddd00555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000033333333d555555d05666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070033333333d555555d56666660006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700033333333d555555d56dddd60006666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333336666666656666660000660600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333331111111156666660000066600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333331111111156666360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333331111111156363360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222220022222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02211112211112200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22171712217171220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22171712217171220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02111112211111200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222220022222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02221220022122200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02211220022112200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01667711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16677771000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16707071000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16707071000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16777771000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
16716161000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010202020201010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101020101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
